---
title: "Tree survival modeling"
author: "Erin Franke"
date: "May 2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Load data and libraries
library(readxl)
library(tidyverse)
library(spaMM)
library(RSpectra)
library(ROI.plugin.glpk)
library(raster)
library(ggtext)
bur_survival <- read_xlsx("BUR ONLY DATA FOR SPATIAL ANALYSIS (SURVIVAL).xlsx") %>%
  mutate(survived = case_when(`Y20 D/L` == "D"~ 0, 
                              TRUE ~ 1))
pin_survival <- read_xlsx("PIN ONLY DATA FOR SPATIAL ANALYSIS (SURVIVAL).xlsx") %>%
  mutate(survived = case_when(`Y20 D/L` == "D"~ 0, 
                              TRUE ~ 1))

pin_survival <- pin_survival %>%
  as.data.frame() 
```

# Exploratory Data Analysis 

## Pin trees 

There is a pretty strong negative relationship between elevation and survival for pin trees, emphasized also by the topographic map. 

```{r, out.width='65%'}
pin_survival %>%
  mutate(ELEVACat = cut(ELEVA,20)) %>%
  group_by(ELEVACat) %>% 
  summarize(prop = mean(survived,na.rm=TRUE)) %>%
  ggplot(aes(x = ELEVACat, y = prop)) + 
  geom_point()+
  theme_classic()+
  labs(title = "Survival rate for Pin trees by elevation category", y="", x="")+
  theme(plot.title.position = "plot", 
        plot.title = element_text(family = "mono"), 
        axis.text.x = element_text(family = "mono", angle = 90), 
        axis.text.y = element_text(family= "mono"))
```

```{r, out.width='65%'}
#These are density plots rather than elevation
pin_survival %>% 
    ggplot(aes(x=X, y=Y, z=ELEVA)) + 
  geom_contour(color = "black", lwd = 0.2) +
    geom_point(aes(color = as.factor(survived)), alpha = 0.3)+
  scale_color_manual(values = c("darkred", "darkgreen"))+
    theme_classic()+
  labs(title = "Pin trees tend to <strong><span style='color:darkred'>die</span></strong></b> more frequently at higher elevations and <strong><span style='color:darkgreen'>survive</span></strong></b> at lower ones")+
  theme(legend.position = "none",
        plot.title.position = "plot", 
        plot.title = element_markdown(family = "mono", size = 8), 
        axis.text = element_text(family = "mono"), 
        axis.title = element_text(family = "mono"))
```

There is a positive moderate relationship between LOG(N) and pin tree survival, as well as diameter and pin tree survival. 

```{r, out.width='65%'}
pin_survival %>%
  mutate(Cat = cut(`LOG(N)`,10)) %>%
  group_by(Cat) %>% 
  summarize(prop = mean(survived,na.rm=TRUE)) %>%
  ggplot(aes(x = Cat, y = prop)) + 
  geom_point()+
  theme_classic()+
  labs(title = "Survival rate for Pin trees by LOG(N) category", y="", x="")+
  theme(plot.title.position = "plot", 
        plot.title = element_text(family = "mono"), 
        axis.text.x = element_text(family = "mono", angle = 90), 
        axis.text.y = element_text(family= "mono"))
```

```{r, out.width='65%'}
pin_survival %>%
  mutate(Cat_DBH = cut(DBH95,10)) %>%
  group_by(Cat_DBH) %>% 
  summarize(prop = mean(survived,na.rm=TRUE)) %>%
  ggplot(aes(x = Cat_DBH, y = prop)) + 
  geom_point()+
  theme_classic()+
  labs(title = "Survival rate for Pin trees by diameter", y="", x="")+
  theme(plot.title.position = "plot", 
        plot.title = element_text(family = "mono"), 
        axis.text.x = element_text(family = "mono", angle = 90), 
        axis.text.y = element_text(family= "mono"))
```

## Bur trees 

There is also a negative relationship between elevation and survival for bur trees, though it is not quite as strong as that for pin trees. 

```{r, out.width='65%'}
bur_survival %>%
  mutate(ELEVACat = cut(ELEVA,20)) %>%
  group_by(ELEVACat) %>% 
  summarize(prop = mean(survived,na.rm=TRUE)) %>%
  ggplot(aes(x = ELEVACat, y = prop)) + 
  geom_point()+
  theme_classic()+
  labs(title = "Survival rate for Bur trees by elevation category", y="", x="")+
  theme(plot.title.position = "plot", 
        plot.title = element_text(family = "mono"), 
        axis.text.x = element_text(family = "mono", angle = 90), 
        axis.text.y = element_text(family= "mono"))
```

```{r, out.width='65%'}
bur_survival %>% 
    ggplot(aes(X, Y)) + 
  geom_density2d(color = "black", lwd = 0.2) +
    geom_point(aes(color = as.factor(survived)), alpha = 0.3)+
  scale_color_manual(values = c("darkred", "darkgreen"))+
    theme_classic()+
  labs(title = "Bur tree <strong><span style='color:darkred'>death</span></strong></b> and <strong><span style='color:darkgreen'>survival</span></strong></b> patterns by elevation are not as clear as pin trees")+
  theme(legend.position = "none",
        plot.title.position = "plot", 
        plot.title = element_markdown(family = "mono", size = 8), 
        axis.text = element_text(family = "mono"), 
        axis.title = element_text(family = "mono"))
```

There does not appear to be a distinct relationship between LOG(N) and bur tree survival. The relationship between diameter and bur tree survival looks somewhat quadratic, with survival being highest at medium diameters and much lower for skinnier or very large trees. 

```{r, out.width='65%'}
bur_survival %>%
  mutate(Cat = cut(`LOG(N)`,10)) %>%
  group_by(Cat) %>% 
  summarize(prop = mean(survived,na.rm=TRUE)) %>%
  ggplot(aes(x = Cat, y = prop)) + 
  geom_point()+
  theme_classic()+
  labs(title = "Survival rate for Bur trees by LOG(N) category", y="", x="")+
  theme(plot.title.position = "plot", 
        plot.title = element_text(family = "mono"), 
        axis.text.x = element_text(family = "mono", angle = 90), 
        axis.text.y = element_text(family= "mono"))
```

```{r, out.width='65%'}
bur_survival %>%
  mutate(Cat_DBH = cut(DBH95,10)) %>%
  group_by(Cat_DBH) %>% 
  summarize(prop = mean(survived,na.rm=TRUE)) %>%
  ggplot(aes(x = Cat_DBH, y = prop)) + 
  geom_point()+
  theme_classic()+
  labs(title = "Survival rate for Bur trees by diameter", y="", x="")+
  theme(plot.title.position = "plot", 
        plot.title = element_text(family = "mono"), 
        axis.text.x = element_text(family = "mono", angle = 90), 
        axis.text.y = element_text(family= "mono"))
```

# Modeling

## Pin trees

Due to computational issues, we had to make this data areal and divided the data into 81 different regions of about equal size. Each region has between 1 and 106 trees, obviously depending on how densely the trees are populated in that region. We then fit a model that accounts for the spatial correlation of the trees using a GEE model. GEE provides robust SE's that are valid even if we specify the wrong correlation structure (which summarizes the correlation between trees in the same region). This means our standard errors will be valid and allow us to create valid confidence intervals and properly conduct hypothesis tests.

In the pin model, elevation and diameter are both significant coefficients on the $\alpha = 0.001$ level. LOG(N) is insignificant with a p-value of 0.274. The elevation coefficient tells us that holding diameter and LOG(N) constant, we expect the odds of survival to decrease by a factor of 0.76 for every one unit increase in pin tree elevation. Additionally, for every one unit increase in pin tree diameter we expect the odds of pin tree survival to increase by a multiplicative factor of 1.024 holding elevation and LOG(N) constant.
```{r, echo=TRUE}
pin_survival$region <- paste0('X',cut(pin_survival$X,breaks=seq(20,420,length = 10)),'Y',cut(pin_survival$Y,breaks=seq(0,400,length = 10)))

pinmod <- pin_survival %>%
  arrange(region) %>%
geeM::geem(survived ~ ELEVA + DBH95 + `LOG(N)`, family = binomial(),id = region, data = .,corstr='exchangeable') 

summary(pinmod)

pin_survival %>%
  group_by(region) %>%
  summarize(maxE = max(ELEVA), minE = min(ELEVA)) %>%
  mutate(regiondif = maxE - minE) %>%
  arrange(desc(regiondif))
```

## Bur trees 

The same type of model can be used to model bur survival. Elevation and diameter are again both significant coefficients on the $\alpha = 0.001$ level. LOG(N) is insignificant with a p-value of 0.274. The elevation coefficient tells us that holding diameter and LOG(N) constant, we expect the odds of survival to decrease by a factor of 0.76 for every one unit increase in pin tree elevation. Additionally, for every one unit increase in pin tree diameter we expect the odds of pin tree survival to increase by a multiplicative factor of 1.024 holding elevation and LOG(N) constant.

```{r}
bur_survival$region <- paste0('X',cut(bur_survival$X,breaks=seq(20,420,length = 10)),'Y',cut(bur_survival$Y,breaks=seq(0,400,length = 10)))

bur_survival <- as.data.frame(bur_survival)

burmod <- bur_survival %>%
  arrange(region) %>%
geeM::geem(survived ~ ELEVA + DBH95 + `LOG(N)`, family = binomial(),id = region, data = .,corstr='exchangeable') 
summary(burmod)

bur_survival %>% count(survived, cut(`LOG(N)`,3))
```


```{r, echo=FALSE}
#pin_mod1 <- fitme(survived ~ cut(ELEVA,3) + DBH95 + Matern(1 | X+Y), fixed = list(nu = 0.5), family = binomial(), data=pin_survival,control.HLfit = list(algebra='decorr'))



#library(glmmTMB)
# fitst we need to create a numeric factor recording the coordinates of the sampled locations
#pin_survival$pos <- numFactor(scale(pin_survival$X), scale(pin_survival$Y))
# then create a dummy group factor to be used as a random term
#pin_survival$ID <- factor(rep(1, nrow(pin_survival)))

# fit the model
#m_tmb <- glmmTMB(survived ~ cut(ELEVA,3) + DBH95 + mat(pos + 0 | ID), pin_survival, family = binomial()) # take some time to fit
# model summary of fixed effects
#summary(m_tmb)
```


