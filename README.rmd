---
title: "Bur Write Up"
output: html_document
date: '2022-04-14'
---

```{r include = FALSE}
require(readxl)
require(dplyr)
require(ggplot2)
require(tidyverse)
require(spaMM)
require(DHARMa)
require(gridExtra)
require(glmmTMB)
set.seed(452)

bur <- read_excel("BUR ONLY DATA FOR SPATIAL ANALYSIS (GROWTH).xlsx")
```

## Data Context & Research Question {-}

We will examine two separate tree growth data sets with the same variables. Both data sets, bur and pin, contain a tree id number, location data, the initial diameter of the tree (measured at breast height), logged soil nitrogen levels, the elevation of the tree, and its growth over 25 years. We will investigate whether or not the elevation of a tree will affect its growth while taking into account different tree diameters. We will also run a similar analysis and see whether or not the logged soil nitrogen levels affect a tree's growth while taking each tree's starting diameter. Both analysis' will be run for the bur and pin dataset resulting in four total models. 

## Bur Tree Maps {-}

```{r}
bur %>%
    ggplot(aes(x = X, y = Y, color = `ELEVA`)) + 
    geom_point() + 
    theme_classic() +
    labs(title = "Bur Trees Map with Elevation", color = "Elevation")

bur %>%
    ggplot(aes(x = X, y = Y, color = `LOG(N)`)) + 
    geom_point() + 
    theme_classic() +
    labs(title = "Bur Trees Map with Logged Soil Nitrogen Levels", color = "Logged Soil Nitrogen")
```

Our initial investigations show that towards the left side of the visualization, where X = 0 to X = 100, elevation is lowest. At X = 200, Y = 200-400, there seems to be a hill as elevation is around ~284. We can also see another hill in the bottom right of the map. The logged soil nitrogen levels are almost the same across the entire map besides a small cluster on the left-hand side at X = 50, Y = 175.

## Examining Variable Relationships {-}

```{r}
bur %>% 
  ggplot(aes(x = DBH95, y = GROWTH)) +
  geom_point() +
  labs(x = "Diameter of Trunk at Breast Height", y = "Growth", title = "Trunk Diameter vs Growth") +
  theme_classic() +
   theme(plot.title = element_text(hjust = 0.5))

p1 <- bur %>% 
  ggplot(aes(x = `LOG(N)`, y = GROWTH)) +
  geom_point() +
  labs(x = "Logged Soil Nitrogen Levels", y = "Growth", title = "Logged Soil Nitrogen vs Growth") +
  theme_classic() +
   theme(plot.title = element_text(hjust = 0.5))

p2 <- bur %>% 
  ggplot(aes(x = ELEVA, y = GROWTH)) +
  geom_point() +
  labs(x = "Elevation", y = "Growth", title = "Elevation vs Growth") +
  theme_classic() +
   theme(plot.title = element_text(hjust = 0.5)) 

grid.arrange(p1, p2, ncol = 2)

bur %>% 
  ggplot(aes(x = GROWTH)) +
  geom_density() +
  labs(x = "Growth", title = "Distribution of Growth") +
  theme_classic() +
    theme(plot.title = element_text(hjust = 0.5)) 
```
Across all exploratory visualizations, we find five bur trees with negative growth (two of them have the same starting trunk diameter and negative growth). We can see that the majority of trees have an initial trunk diameter between 5 and 20. Also, when looking at the logged soil nitrogen levels, we see just a few trees have high levels while the majority remain around 5.5 to 7.5, similar to what we saw from the soil nitrogen map above. The elevation of the trees looks relatively normal. Finally, we see that our outcome variable `Growth` is left-skewed, primarily due to a single outlier. I will remove this outlier so that that our model will not systematically under predict tree growth. 

```{r}
bur <- bur %>% 
  filter(GROWTH > -40)
```


## Linear Models {-}

### Creating and Interpretating the Models
```{r}
lm_bur_eleva <- lm(GROWTH ~ ELEVA + DBH95, data = bur)

summary(lm_bur_eleva)
```

Our first model, we will utilize ordinary least-squares to measure how elevation and the logged base diameter of a tree affect the trees growth. The intercept does not make sense to interpret in the data context as a tree cannot have a base trunk diameter of zero. We'd expect the average tree to shrink 0.19 units for every 1 unit increase in elevation while holding the base diameter of a tree constant. Additionally, we'd expect the average tree to grow around 0.073 units for every 1 unit increase in base diameter of a tree while holding elevation constant. All the coefficients have statistically significant p-values. 

```{r}
lm_bur_n <- lm(GROWTH ~ `LOG(N)` + DBH95, data = bur)

summary(lm_bur_n)
```

In our second ordinary least squares model, we measure how logged soil nitrogen levels and the base diameter of the trunk affect tree growth. Again, the intercept does not make sense to interpret as a tree cannot have a trunk diameter of zero. We'd expect the average tree to grow by 0.831 units for every 1 unit increase in logged soil nitrogen levels while holding the base diameter of a tree constant. Additionally, we'd expect the average tree to grow around 0.073 units for every 1 unit increase in base diameter of a tree while holding logged soil nitrogen levels constant. Also, all the coefficients are statistically significant.   

```{r include = FALSE}
lm.model.map <- cbind(bur, lm_bur_eleva_pred = predict(lm_bur_eleva)) %>%
    mutate(lm_bur_eleva_resid = GROWTH - lm_bur_eleva_pred)

lm.model.map2 <- cbind(bur, lm_bur_n_pred = predict(lm_bur_n)) %>%
    mutate(lm_bur_n_resid = GROWTH - lm_bur_n_pred)
```

### Limitations of Linear Models

While these linear models are a good starting point, they fail to take into consideration the tree's location. If two trees are close together, they might be spatially correlated with each other. Without taking this spatial correlation into consideration, we will get inaccurate standard errors for our models, however the slope estimates are still accurate. To fix this problem, we will utilize a spatial mixed-effects model that will account for the location of the trees while also allowing for each tree to have a different intercept for its trunk diameter.

## Spatial Mixed-Effects Models {-}

### Quick Overview of spaMM Models

Similar to the ordinary least squares model, for the spatial mixed-effects models I will create two models. One of the models will have elevation as a predictor and the other will have logged soil nitrogen levels. For both the models I will utilize a Matérn covariance matrix. The Matérn covariance matrix is a common method when computing spatial mix-effects models as it will allow us to calculate the Matérn covariance between two points separated by a distance, d. For both models, I will use an unset $\nu$ parameter to have the optimized values of $\nu$ and $\rho$ which produce the lowest residuals. For larger data sets, we could utilize a $\nu = 0.5$ to make our model more computationally efficient at the cost of accuracy. However, the bur tree data set is small enough where our model with an unset paramter should only take a few minutes to run. 

### Spatial Elevation Models

```{r}
spa_bur_eleva_gaussian <- fitme(GROWTH ~ ELEVA + DBH95 + Matern(1 | X + Y), data = bur, family = "gaussian")
```

```{r}
spaMM.model.map <- cbind(bur, spa_bur_eleva_gaussian_pred = predict(spa_bur_eleva_gaussian)) %>% 
    mutate(spa_bur_eleva_gaussian_resid = GROWTH - spa_bur_eleva_gaussian_pred)

# spaMM Elevation RMSE
sqrt(mean(spaMM.model.map$spa_bur_eleva_gaussian_resid^2))
```


### Spatial Soil Nitrogen Models

```{r}
spa_bur_n_gaussian <- fitme(GROWTH ~ `LOG(N)` + DBH95 + Matern(1 | X + Y), data = bur, family = "gaussian")
```

```{r}
spaMM.model.map2 <- cbind(bur, spa_bur_n_gaussian_pred = predict(spa_bur_n_gaussian)) %>% 
    mutate(spa_bur_n_gaussian_resid = GROWTH - spa_bur_n_gaussian_pred)
```


## OLS vs Spatial Elevation Model Comparison {-}

### Elevation Evaluation Metrics

```{r}
# OLS RMSE
sqrt(mean(lm.model.map$lm_bur_eleva_resid^2))

# spaMM RMSE
sqrt(mean(spaMM.model.map$spa_bur_eleva_gaussian_resid^2))
```

When using BIC scores (lower = better) we find that our spatially mixed effect model has a significantly lower BIC score (0.963) than the OLS elevation model (2.450).

### Elevation Residual Maps

```{r}
lm.model.map %>% 
  ggplot(aes(x = X, y = Y, color = lm_bur_eleva_resid)) +
  geom_point() + 
  theme_classic() +
  scale_color_gradient2(low = "blue", mid = "lightgrey", high = "red") +
  labs(title = "OLS Elevation Model", color = "Residuals")

spaMM.model.map %>% 
  ggplot(aes(x = X, y = Y, color = spa_bur_eleva_gaussian_resid)) +
  geom_point() + 
  theme_classic() +
  scale_color_gradient2(low = "blue", mid = "lightgrey", high = "red") +
  labs(title = "Spatial Mixed-Effects Elevation Model", color = "Residuals")
```

Looking at the residual maps for our OLS and spaMM elevation models we can see that the scale on the right-hand side is much larger for the OLS model. This indicates that the magnitude for the residuals of the spatial mixed-effects model is much smaller, which is ideal. Additionally, when looking at the residual map for the spatial mixed effects model, there does not seem to be any specific area where our model is systematically over or under predicting the residuals. This leads us to believe that there might be no spatial correlation among the tress. 

## OLS vs Spatial Soil Nitrogen Model Comparison {-}

### Soil Nitrogen Evaluation Metrics

```{r}
# OLS RMSE
sqrt(mean(lm.model.map2$lm_bur_n_resid^2))

# spaMM RMSE
sqrt(mean(spaMM.model.map2$spa_bur_n_gaussian_resid^2))
```

Similar to our elevation models, the spatially mixed-effects model produce a lower BIC score (0.945) compared to the OLS model's BIC score (2.436).

### Soil Nitrogen Residual Map

```{r}
lm.model.map2 %>% 
  ggplot(aes(x = X, y = Y, color = lm_bur_n_resid)) +
  geom_point() + 
  theme_classic() +
  scale_color_gradient2(low = "blue", mid = "lightgrey", high = "red") +
  labs(title = "OLS Soil Nitrogen Model", color = "Residuals")

spaMM.model.map2 %>% 
  ggplot(aes(x = X, y = Y, color = spa_bur_n_gaussian_resid)) +
  geom_point() + 
  theme_classic() +
  scale_color_gradient2(low = "blue", mid = "lightgrey", high = "red") +
  labs(title = "Spatial Mixed-Effects Soil Nitrogen Model", color = "Residuals")
```

Again, looking at our residual maps, we see from the scale that the magnitude of the residuals from our spatially mixed effects model are much lower. However, there seems to be no pattern for which areas are over and under predicted, so our data might not be spatially correlated. 

## Random Effects Elevation Model

```{r}
# Not working
#randomeffects_eleva <- lmer(GROWTH ~ ELEVA + DBH95 + (DBH95 | ID_), data = bur)
```


## Conclusion
